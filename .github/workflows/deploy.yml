name: Deploy & Monitor The Threefold Chaos

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Health check every hour
    - cron: '0 * * * *'

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ“¢ Notify Discord - Build Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âœ… Build Successful"
          description: |
            **The Threefold Chaos** build completed successfully
            ğŸ“¦ Commit: `${{ github.event.head_commit.message }}`
            ğŸ‘¤ By: ${{ github.actor }}
          color: 0x00ff00
          username: "GitHub Actions Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: ğŸ“¢ Notify Discord - Build Failed
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âŒ Build Failed"
          description: |
            **The Threefold Chaos** build failed!
            ğŸ“¦ Commit: `${{ github.event.head_commit.message }}`
            ğŸ‘¤ By: ${{ github.actor }}
            ğŸ”— [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          color: 0xff0000
          username: "GitHub Actions Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¢ Notify Discord - Deploy Started
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš€ Deployment Started"
          description: |
            **The Threefold Chaos** is being deployed to production...
            ğŸ“¦ Commit: `${{ github.event.head_commit.message }}`
            ğŸ‘¤ By: ${{ github.actor }}
          color: 0xffff00
          username: "GitHub Actions Bot"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /root/The_Threefold_Chaos
            
            # Clean up Docker resources to free disk space
            echo "ğŸ§¹ Cleaning Docker resources..."
            docker system prune -af --volumes || true
            
            # Pull latest code
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main
            
            # Build and deploy
            echo "ğŸ—ï¸ Building and deploying..."
            docker-compose up -d --build

      - name: âœ… Health Check
        id: health
        run: |
          echo "Waiting for deployment to complete..."
          sleep 15
          echo "Checking application health..."
          STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://threefold.31.207.36.113.nip.io || echo "000")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "HTTP Status: $STATUS"
          if [[ "$STATUS" != "200" ]]; then
            echo "Health check failed with status $STATUS"
            exit 1
          fi
          echo "Health check passed with status $STATUS!"

      - name: ğŸ“¢ Notify Discord - Deploy Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸ‰ Deployment Successful"
          description: |
            **The Threefold Chaos** is now live in production! ğŸ®
            
            ğŸŒ **URL:** https://threefold.31.207.36.113.nip.io
            ğŸ’š **Status:** Healthy (HTTP ${{ steps.health.outputs.status }})
            ğŸ“¦ **Commit:** `${{ github.event.head_commit.message }}`
            ğŸ‘¤ **By:** ${{ github.actor }}
          color: 0x0099ff
          username: "GitHub Actions Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: ğŸ“¢ Notify Discord - Deploy Failed
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸ’¥ Deployment Failed"
          description: |
            **The Threefold Chaos** deployment failed!
            
            âŒ **Status:** Failed
            ğŸ“¦ **Commit:** `${{ github.event.head_commit.message }}`
            ğŸ‘¤ **By:** ${{ github.actor }}
            ğŸ”— [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            @everyone - Production deployment needs attention!
          color: 0xff0000
          username: "GitHub Actions Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

  health-check:
    name: Scheduled Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: ğŸ¥ Check Application Health
        id: health
        run: |
          STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://threefold.31.207.36.113.nip.io || echo "000")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "HTTP Status: $STATUS"
          if [[ "$STATUS" != "200" ]]; then
            exit 1
          fi

      - name: ğŸ“¢ Notify Discord - Health OK
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸ’š Health Check Passed"
          description: |
            **The Threefold Chaos** is running smoothly!
            
            âœ… **Status:** Healthy (HTTP ${{ steps.health.outputs.status }})
            ğŸŒ **URL:** https://threefold.31.207.36.113.nip.io
          color: 0x00ff00
          username: "Health Monitor Bot"
          avatar_url: "https://cdn-icons-png.flaticon.com/512/2913/2913133.png"

      - name: ğŸ“¢ Notify Discord - Health Failed
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš¨ Health Check Failed"
          description: |
            âš ï¸ **The Threefold Chaos** is DOWN!
            
            âŒ **Status:** HTTP ${{ steps.health.outputs.status }}
            ğŸŒ **URL:** https://threefold.31.207.36.113.nip.io
            
            @everyone - Application needs immediate attention!
          color: 0xff0000
          username: "Health Monitor Bot"
          avatar_url: "https://cdn-icons-png.flaticon.com/512/2913/2913133.png"
